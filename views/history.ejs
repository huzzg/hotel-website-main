<!-- views/history.ejs -->
<%- include('partials/header') %>

<div class="container my-5 pt-5">
  <h3 class="mb-4">Lịch sử đặt phòng</h3>

  <% if (!bookings || bookings.length === 0) { %>
    <div class="alert alert-info">Bạn chưa có đơn đặt phòng nào.</div>
  <% } else { %>
    <div class="row g-3">
      <% bookings.forEach(function(b) {
          const checkIn = new Date(b.checkIn || b.createdAt);
          const checkOut = new Date(b.checkOut || b.createdAt);
          const nights = Math.max(1, Math.round((checkOut - checkIn) / (1000*60*60*24)));
          const price = Number(b.totalPrice || 0);
          const status = (b.status || 'pending').toLowerCase();
          let statusText = 'Chờ xác nhận';
          if (status === 'paid') statusText = 'Đã thanh toán';
          else if (status === 'confirmed') statusText = 'Đã xác nhận';
          else if (status === 'checked_in') statusText = 'Đã nhận phòng';
          else if (status === 'checked_out') statusText = 'Đã trả phòng';
          else if (status === 'cancelled') statusText = 'Đã hủy';
      %>
        <div class="col-12">
          <div class="history-card shadow-sm rounded d-flex align-items-center p-3 bg-white">
            <div class="me-3 flex-shrink-0">
              <% if (b.roomId && b.roomId.images && b.roomId.images.length) { %>
                <img src="<%= b.roomId.images[0] %>" alt="room" class="history-thumb rounded">
              <% } else { %>
                <img src="/images/default-avatar.jpg" alt="room" class="history-thumb rounded">
              <% } %>
            </div>

            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h5 class="mb-1 fw-bold">
                    <%= b.roomId?.roomNumber || b.roomId?.name || 'Phòng' %>
                    <small class="text-muted ms-2">· <%= b.roomId?.type || '' %></small>
                  </h5>
                  <div class="text-muted small">
                    <span>Check-in: <strong><%= checkIn.toLocaleDateString('vi-VN') %></strong></span>
                    <span class="mx-2">|</span>
                    <span>Check-out: <strong><%= checkOut.toLocaleDateString('vi-VN') %></strong></span>
                    <span class="mx-2">|</span>
                    <span>Số đêm: <strong><%= nights %></strong></span>
                  </div>
                </div>

                <div class="text-end">
                  <div class="mb-2">
                    <% 
                      let badgeClass = 'badge bg-secondary';
                      if (status === 'paid') badgeClass = 'badge bg-success';
                      else if (status === 'confirmed' || status === 'checked_in') badgeClass = 'badge bg-primary';
                      else if (status === 'cancelled') badgeClass = 'badge bg-danger';
                    %>
                    <span class="<%= badgeClass %> px-3 py-2" style="font-size:0.9rem;"><%= statusText %></span>
                  </div>

                  <div class="fw-semibold text-dark" style="font-size:1.05rem;">
                    <%= price.toLocaleString('vi-VN') %> đ
                  </div>
                </div>
              </div>

              <% if (b.roomId?.description) { %>
                <p class="mb-2 mt-2 text-muted small"><%= b.roomId.description %></p>
              <% } %>

              <div class="mt-3 d-flex gap-2 justify-content-end">
                <a class="btn btn-outline-primary btn-sm" href="/user/booking-confirm?bookingId=<%= b._id %>">Chi tiết</a>

                <% 
                  // Chỉ hiện nút Thanh toán nếu booking ở trạng thái cho phép thanh toán
                  const disallowedPayment = ['paid','checked_in','checked_out','confirmed','cancelled'];
                  const canPay = !disallowedPayment.includes(status);
                %>

                <% if (canPay) { %>
                  <!-- chỉ hiện nút Thanh toán nếu được phép -->
                  <a class="btn btn-success btn-sm" href="/payment/user?bookingId=<%= b._id %>">Thanh toán</a>
                <% } else { %>
                  <a class="btn btn-outline-secondary btn-sm" href="/user/booking-confirm?bookingId=<%= b._id %>">Xem hoá đơn</a>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</div>

<%- include('partials/footer') %>
